#summary Repository commit notifications

==Overview==
Post-Commit Web Hooks allow projects to setup web services that receive project commit notifications from Google Code. Such services could be used to integrate external tools including continuous build systems, bug trackers, project metrics, and social networks.


==Details==

Project owners may enable this feature by specifying a target URL in the Administer/Source tab. If the URL contains the special patterns "%p" and "%r", those will be automatically replaced for each commit with the project name and revision number, respectively.

The POST request payload describes the commit using the [http://webhooks.pbwiki.com/ Web Hooks] model, and consists of a UTF8-encoded [http://www.json.org/ JSON] dictionary in the following format:

<pre>
{
  project_name:  "atlas-build-tool",
  repository_path: "http://atlas-build-tool.googlecode.com/svn/",
  revision_count: 1,
  revisions: [
    { revision: 33,
      author: "mparent61",
      timestamp:   1229470699,
      message: "working on easy_install",
      path_count: 4,
      added: ["/trunk/atlas_main.py"],
      modified: ["/trunk/Makefile", "/trunk/constants.py"],
      removed: ["/trunk/atlas.py"],
    },
  ],
}
</pre>

While we will make a best effort to promptly deliver all Post-Commit Web Hook notifications, messages are not guaranteed to arrive, and may not arrive in order of commit. If we fail to reach the specified URL, we will retry several times over a 24 hour period. This allows your services to be down for short maintenance windows and still receive all messages.

Note: Notifications for commits via the 'svnsync' command are not yet supported.

==Notification Format==

The payload's [http://www.json.org/ JSON] dictionary contains the following items:

|| *Field* || *Type* || *Description* ||
|| project_name ||String|| The name of the project. ||
|| repository_path ||String|| The project's repository URL.||
|| revision_count ||Number|| Number of revisions contained in the 'revisions' list. Currently always set to '1'.||
|| revisions ||List|| A list of dictionaries describing 1 or more repository commits (see table below).||

Each revision contained in the 'revisions' list is a dictionary with the following items:

|| *Field* || *Type* || *Description* ||
||revision|| Number || Repository identifier for this commit.||
||author|| String || Username responsible for commit.||
||timestamp|| Number ||Repository commit timestamp.||
||message||String||Commit log message.||
||path_count||Number||Total number of paths modified in this revision. Only a fixed number of paths will be included per revision, so this number is used to determine whether a partial list was sent.||
||added||List||A list of String paths added by this revision.||
||modified||List||A list of String paths modified by this revision.||
||removed||List||A list of String paths removed by this revision.||

It is important to note that a revision's list of changed paths will be truncated for large commits in order to limit message sizes. Full commit information can be obtained using standard repository tools.

====Example: Processing a notification using a Python [http://code.google.com/appengine/ AppEngine] service====
<pre>
import logging
from django.utils import simplejson
from google.appengine import webapp
class Listener(webapp.!RequestHandler):
  def post(self):
    payload = simplejson.loads(self.request.body)
    for revision in payload['revisions']:
      logging.info('Project %s, revision %s contains %s paths',
                   payload['project_name'],
                   revision['revision'],
                   revision['path_count'])
</pre>


==Authentication==

Post-Commit Web Hooks use [http://en.wikipedia.org/wiki/HMAC HMAC] to authenticate requests.
Every project has a unique post-commit 'secret key', visible to project owners in the Administer/Source tab. This key is used to seed the HMAC algorithm.
Each POST request header contains a HMAC used to authenticate the payload. This value is a 40-character hexadecimal string contained in the 'Google-Code-Project-Hosting-Hook-Hmac' header. 
By combining your project's secret key and the POST request's HMAC value, you can authenticate the request.

====Example: Authentication using a Python [http://code.google.com/appengine/ AppEngine] service====
<pre>
import hmac
import logging
from google.appengine import webapp
class Listener(webapp.!RequestHandler):
  def post(self):
    project_secret_key = '0123456789abcdef'  # From Administer/Source tab
    m = hmac.new(project_secret_key)
    m.update(self.request.body)
    digest = m.hexdigest()
    if digest == self.request.headers['Google-Code-Project-Hosting-Hook-Hmac']:
      print "Authenticated"
    else:
      print "Authentication failed!"
</pre>